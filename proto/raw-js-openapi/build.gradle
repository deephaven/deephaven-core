plugins {
    id 'com.bmuschko.docker-remote-api'
}

evaluationDependsOn ':proto'
evaluationDependsOn ':proto:proto-backplane-grpc'

def backplaneProject = project(':proto:proto-backplane-grpc')
def webpackSourcesLocation = "${buildDir}/dhapi"

Docker.registerDockerTask(project, 'webpackSources') {
    copyIn {
        from(backplaneProject.tasks.findByName('generateProtobuf').outputs.files) {
            // note: we are only copying the JS and not TS files.
            include '**/*.js'
            into 'raw-js-openapi/build/js-src'
        }

        from('src') {
            into 'raw-js-openapi/src'
        }

        from ('webpack.config.js') {
            into 'raw-js-openapi/'
        }
        from ('tsconfig.json') {
            into 'raw-js-openapi/'
        }
        from ('Dockerfile')
        from ('../package.json')
        from ('../package-lock.json')

    }
    imageName = 'deephaven/js-out:local-build'
    containerOutPath = '/usr/src/app/raw-js-openapi/build/js-out'
    copyOut {
        into(webpackSourcesLocation)
    }
}
